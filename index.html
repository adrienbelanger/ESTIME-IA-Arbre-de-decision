<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Créateur d'Arbre de Décision</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <style>
html {
  height: 100%;
}

body {
  margin: 0;
  font-family: Arial, sans-serif;
  height: 100%;
  overflow: auto;
}

    #toolbar {
      padding: 10px;
      background: #f4f4f4;
      border-bottom: 1px solid #ccc;
      display: flex;
      gap: 8px;
      align-items: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }

    #cy {
      width: 100%;
      height: calc(100vh - 50px);
      position: relative;

    }

    .shape-btn {
      width: 50px;
      height: 30px;
      border: none;
      margin: 0 6px;
      padding: 0;
      cursor: pointer;
      background: none;
    }

    .decision-shape {
      background: #4CAF50;
      clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
    }

    .leaf-shape {
      background: #2196F3;
      border-radius: 8px;
    }

    #trash {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: url('https://img.icons8.com/ios-filled/50/000000/trash.png') no-repeat center center;
      background-size: contain;
      opacity: 0.6;
      transition: opacity 0.2s;
      z-index: 9999;
    }

    #trash.hovered {
      opacity: 1;
      filter: drop-shadow(0 0 5px red);
    }

    #undoBtn, #redoBtn {
      width: 30px;
      height: 30px;
      cursor: pointer;
    }

    #labelEditor {
      position: absolute;
      z-index: 10000;
      display: none;
      border: 1px solid #aaa;
      padding: 4px;
      font-size: 14px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
  </style>
  <script src="https://unpkg.com/cytoscape@3.32.1/dist/cytoscape.min.js"></script>
</head>
<body>
  <div id="toolbar">
    <div class="shape-btn decision-shape" title="Ajouter un nœud de décision" id="addDecision"></div>
    <div class="shape-btn leaf-shape" title="Ajouter un nœud résultat" id="addLeaf"></div>
    <img id="undoBtn" src="https://img.icons8.com/ios-glyphs/30/000000/undo.png" title="Annuler">
    <img id="redoBtn" src="https://img.icons8.com/ios-glyphs/30/000000/redo.png" title="Rétablir">
  </div>

  <div id="cy"></div>
  <input id="labelEditor" type="text" />
  <div id="trash" title="Glissez ici pour supprimer"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: [],
        style: [
          {
            selector: 'node',
            style: {
              'label': 'data(label)',
              'text-valign': 'center',
              'text-halign': 'center',
              'color': '#fff',
              'width': 'label',
              'height': 50,
              'background-color': '#666'
            }
          },
          {
            selector: '.decision',
            style: {
              'shape': 'diamond',
              'background-color': '#4CAF50',
              'padding': '30px'
            }
          },
          {
            selector: '.leaf',
            style: {
              'shape': 'roundrectangle',
              'background-color': '#2196F3',
              'padding': '10px'
            }
          },
          {
            selector: 'edge',
            style: {
              'width': 2,
              'line-color': '#000',
              'target-arrow-shape': 'triangle',
              'target-arrow-color': '#000',
              'arrow-scale': 1.2,
              'curve-style': 'bezier',
              'target-distance-from-node': 0,
              'label': 'data(label)',
              'text-margin-x': 0,
              'text-margin-y': -10,
              'text-background-opacity': 1,
              'text-background-color': '#fff',
              'text-background-shape': 'roundrectangle',
              'text-background-padding': 2,
              'font-size': 12,
              'text-rotation': 'autorotate'
            }
          }
        ],
        layout: { name: 'preset' }
        
      });

      cy.container().addEventListener('contextmenu', e => e.preventDefault());

      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('style', 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10');
      const defs = document.createElementNS(svgNS, 'defs');
      const marker = document.createElementNS(svgNS, 'marker');
      marker.setAttribute('id', 'arrowHead');
      marker.setAttribute('markerWidth', '6');
      marker.setAttribute('markerHeight', '6');
      marker.setAttribute('refX', '0');
      marker.setAttribute('refY', '3');
      marker.setAttribute('orient', 'auto');
      const path = document.createElementNS(svgNS, 'path');
      path.setAttribute('d', 'M0,0 L0,6 L6,3 z');
      path.setAttribute('fill', '#000');
      marker.appendChild(path);
      defs.appendChild(marker);
      svg.appendChild(defs);
      const line = document.createElementNS(svgNS, 'line');
      line.setAttribute('id', 'previewLine');
      line.setAttribute('stroke', '#000');
      line.setAttribute('stroke-width', '2');
      line.setAttribute('marker-end', 'url(#arrowHead)');
      line.setAttribute('visibility', 'hidden');
      svg.appendChild(line);
      cy.container().appendChild(svg);

      let nextNodeId = 0;
      let nextEdgeId = 0;
      let linkOrigin = null;
      let linkTarget = null;
      let didDrag = false;

      function addNode(type) {
        cy.add({
          group: 'nodes',
          data: {
            id: 'n' + nextNodeId,
            label: type === 'decision' ? 'Décision' : 'Résultat'
          },
          classes: type,
          position: {
            x: 100 + Math.random() * 400,
            y: 100 + Math.random() * 300
          }
        });
        nextNodeId++;
        saveState();
      }

      document.getElementById('addDecision').addEventListener('click', () => addNode('decision'));
      document.getElementById('addLeaf').addEventListener('click', () => addNode('leaf'));

      cy.on('cxttapstart', 'node', evt => {
        linkOrigin = evt.target;
        didDrag = false;
        linkTarget = null;
        const p = linkOrigin.renderedPosition();
        line.setAttribute('x1', p.x);
        line.setAttribute('y1', p.y);
        line.setAttribute('x2', p.x);
        line.setAttribute('y2', p.y);
        line.setAttribute('visibility', 'visible');
      });

      cy.on('dbltap', 'node', evt => {
        if (!didDrag) {
          const node = evt.target;
          const pos = node.renderedPosition();
          showLabelEditor(node, pos, node.data('label'));
        }
      });

      cy.on('dbltap', 'edge', evt => {
        const edge = evt.target;
        // model-space midpoint:
        const mid = edge.midpoint();           // {x, y} in graph coordinates
        // convert to rendered (pixel) coords:
        const z = cy.zoom();
        const pan = cy.pan();
        const rendered = { x: mid.x * z + pan.x, y: mid.y * z + pan.y };
        showLabelEditor(edge, rendered, edge.data('label') || '');
      });

      cy.on('cxtdrag', evt => {
        if (!linkOrigin) return;
        didDrag = true;
        const rp = evt.renderedPosition;
        line.setAttribute('x2', rp.x);
        line.setAttribute('y2', rp.y);
      });

      cy.on('cxtdragover', 'node', evt => {
        if (didDrag && evt.target.id() !== linkOrigin.id()) {
          linkTarget = evt.target;
        }
      });

      cy.on('cxtdragout', 'node', evt => {
        if (linkTarget && evt.target.id() === linkTarget.id()) {
          linkTarget = null;
        }
      });

      cy.on('cxttapend', () => {
        line.setAttribute('visibility', 'hidden');
        if (didDrag && linkOrigin && linkTarget && linkOrigin.id() !== linkTarget.id()) {
          const existingOutgoing = cy.edges().filter(edge => edge.source().id() === linkOrigin.id()).length;
          let label = '';
          if (existingOutgoing === 0) label = 'oui';
          else if (existingOutgoing === 1) label = 'non';

          cy.add({
            group: 'edges',
            data: {
              id: 'e' + nextEdgeId,
              source: linkOrigin.id(),
              target: linkTarget.id(),
              label: label
            }
          });

          nextEdgeId++;
          saveState();
        }
        linkOrigin = linkTarget = null;
        didDrag = false;
      });

      const trash = document.getElementById('trash');
      let nodeBeingDragged = null;

      cy.on('grab', 'node', evt => {
        nodeBeingDragged = evt.target;
      });

      cy.on('drag', evt => {
        if (!nodeBeingDragged) return;
        const rect = trash.getBoundingClientRect();
        const pos = evt.renderedPosition;
        const containerRect = cy.container().getBoundingClientRect();
        const absoluteX = containerRect.left + pos.x;
        const absoluteY = containerRect.top + pos.y;

        if (
          absoluteX >= rect.left &&
          absoluteX <= rect.right &&
          absoluteY >= rect.top &&
          absoluteY <= rect.bottom
        ) {
          trash.classList.add('hovered');
        } else {
          trash.classList.remove('hovered');
        }
      });

      cy.on('free', 'node', evt => {
        if (!nodeBeingDragged) return;
        const pos = evt.renderedPosition;
        const rect = trash.getBoundingClientRect();
        const containerRect = cy.container().getBoundingClientRect();
        const absoluteX = containerRect.left + pos.x;
        const absoluteY = containerRect.top + pos.y;

        const wasInTrash =
          absoluteX >= rect.left &&
          absoluteX <= rect.right &&
          absoluteY >= rect.top &&
          absoluteY <= rect.bottom;

        if (wasInTrash) {
          nodeBeingDragged.connectedEdges().remove();
          nodeBeingDragged.remove();
        } else {
          saveState();
        }

        trash.classList.remove('hovered');
        nodeBeingDragged = null;
      });

      let undoStack = [];
      let redoStack = [];

      function saveState() {
        const snapshot = JSON.parse(JSON.stringify(cy.elements().jsons()));
        undoStack.push(snapshot);
        if (undoStack.length > 50) undoStack.shift();
        redoStack = [];
      }

      function restoreState(snapshot) {
        cy.elements().remove();
        if (snapshot && snapshot.length > 0) {
          cy.add(snapshot);
        }
        const allIds = cy.nodes().map(n => parseInt(n.id().replace('n',''), 10)).filter(n => !isNaN(n));
        const edgeIds = cy.edges().map(e => parseInt(e.id().replace('e',''), 10)).filter(n => !isNaN(n));
        nextNodeId = allIds.length ? Math.max(...allIds) + 1 : 0;
        nextEdgeId = edgeIds.length ? Math.max(...edgeIds) + 1 : 0;
      }

      saveState();

      document.getElementById('undoBtn').addEventListener('click', () => {
        if (undoStack.length > 1) {
          redoStack.push(undoStack.pop());
          restoreState(undoStack[undoStack.length - 1]);
        }
      });

      document.getElementById('redoBtn').addEventListener('click', () => {
        if (redoStack.length > 0) {
          const state = redoStack.pop();
          restoreState(state);
          undoStack.push(state);
        }
      });

      // Label editor logic
      const labelEditor = document.getElementById('labelEditor');
      let labelEditingElement = null;

      function showLabelEditor(ele, renderedPos, currentLabel) {
        labelEditingElement = ele;
        labelEditor.value = currentLabel || '';
        labelEditor.style.left = `${renderedPos.x}px`;
        labelEditor.style.top = `${renderedPos.y}px`;
        labelEditor.style.display = 'block';
        labelEditor.focus();
        labelEditor.select();
      }

      labelEditor.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          commitLabelEdit();
        } else if (e.key === 'Escape') {
          cancelLabelEdit();
        }
      });

      labelEditor.addEventListener('blur', commitLabelEdit);

      function commitLabelEdit() {
        if (labelEditingElement && labelEditor.value.trim() !== '') {
          labelEditingElement.data('label', labelEditor.value.trim());
          saveState();
        }
        labelEditor.style.display = 'none';
        labelEditingElement = null;
      }

      function cancelLabelEdit() {
        labelEditor.style.display = 'none';
        labelEditingElement = null;
      }
    });
  </script>
</body>
</html>
